{
  "version": 3,
  "sources": ["src/app/core/services/product.service.ts"],
  "sourcesContent": ["import { Injectable, inject, Injector, runInInjectionContext } from '@angular/core';\nimport { Observable, map, combineLatest } from 'rxjs';\nimport { Firestore, collectionData, docData } from '@angular/fire/firestore';\nimport {\n  doc,\n  collection,\n  deleteDoc,\n  writeBatch,\n  query,\n  where,\n  orderBy,\n  limit,\n  Timestamp,\n  WithFieldValue,\n  QueryConstraint,\n  addDoc,\n  updateDoc,\n  DocumentReference,\n} from 'firebase/firestore';\nimport { Product, ProductVariant } from '../models/product.model';\nimport { convertTimestampsToDates } from '@core/utils/date-converter';\n\nexport interface ProductFilters {\n  categoryId?: string | null;\n  minPrice?: number | null;\n  maxPrice?: number | null;\n  includeOutOfStock?: boolean;\n  dynamicFilters: { [key: string]: string[] };\n}\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class ProductService {\n  private firestore: Firestore = inject(Firestore);\n  private injector = inject(Injector);\n  private readonly collectionPath = 'products';\n\n  getProducts(): Observable<Product[]> {\n    return runInInjectionContext(this.injector, () => {\n      const collectionRef = collection(this.firestore, this.collectionPath);\n      return (collectionData(collectionRef, { idField: 'id' }) as Observable<any[]>).pipe(\n        map(items => items.map(item => convertTimestampsToDates(item) as Product))\n      );\n    });\n  }\n\n  getProductsByQuery(categoryId: string | null): Observable<Product[]> {\n    return runInInjectionContext(this.injector, () => {\n      const constraints: QueryConstraint[] = [];\n      if (categoryId && categoryId !== 'all') {\n        constraints.push(where('categoryId', '==', categoryId));\n      }\n      \n      const q = query(collection(this.firestore, this.collectionPath), ...constraints);\n      return (collectionData(q, { idField: 'id' }) as Observable<any[]>).pipe(\n        map(items => items.map(item => convertTimestampsToDates(item) as Product))\n      );\n    });\n  }\n\n  getProductById(id: string): Observable<Product | undefined> {\n    return runInInjectionContext(this.injector, () => {\n      const docRef = doc(this.firestore, `${this.collectionPath}/${id}`);\n      return (docData(docRef, { idField: 'id' }) as Observable<any | undefined>).pipe(\n        map(item => (item ? (convertTimestampsToDates(item) as Product) : undefined))\n      );\n    });\n  }\n\n  getProductWithVariants(id: string): Observable<{ product: Product; variants: ProductVariant[] } | undefined> {\n    return runInInjectionContext(this.injector, () => {\n      const product$ = this.getProductById(id);\n      const variantsCollectionRef = collection(this.firestore, `${this.collectionPath}/${id}/variants`);\n      const variants$ = (collectionData(variantsCollectionRef, { idField: 'id' }) as Observable<ProductVariant[]>);\n\n      return combineLatest([product$, variants$]).pipe(\n        map(([product, variants]) => {\n          if (!product) {\n            return undefined;\n          }\n          return {\n            product,\n            variants: variants.map(v => convertTimestampsToDates(v) as ProductVariant),\n          };\n        })\n      );\n    });\n  }\n\n  async createProductWithVariants(\n    product: WithFieldValue<Omit<Product, 'id'>>,\n    variants: WithFieldValue<Omit<ProductVariant, 'id' | 'productId'>>[]\n  ): Promise<string> {\n    const batch = writeBatch(this.firestore);\n    const productCollectionRef = collection(this.firestore, this.collectionPath);\n    const newProductRef = doc(productCollectionRef);\n\n    batch.set(newProductRef, product);\n\n    variants.forEach(variantData => {\n      const newVariantRef = doc(collection(newProductRef, 'variants'));\n      const variantWithId: WithFieldValue<Omit<ProductVariant, 'id'>> = {\n        ...variantData,\n        productId: newProductRef.id,\n      };\n      batch.set(newVariantRef, variantWithId);\n    });\n\n    await batch.commit();\n    return newProductRef.id;\n  }\n\n  async updateProductWithVariants(\n    productId: string,\n    productData: Partial<Product>,\n    variantsToUpdate: (Partial<ProductVariant> & { id: string })[],\n    variantsToAdd: WithFieldValue<Omit<ProductVariant, 'id' | 'productId'>>[],\n    variantIdsToDelete: string[]\n  ): Promise<void> {\n    const batch = writeBatch(this.firestore);\n    const productRef = doc(this.firestore, this.collectionPath, productId);\n\n    batch.update(productRef, productData);\n\n    const variantsCollectionRef = collection(productRef, 'variants');\n\n    variantsToUpdate.forEach(variant => {\n      const variantRef = doc(variantsCollectionRef, variant.id);\n      batch.update(variantRef, variant);\n    });\n\n    variantsToAdd.forEach(variantData => {\n      const newVariantRef = doc(variantsCollectionRef);\n      const variantWithId: WithFieldValue<Omit<ProductVariant, 'id'>> = {\n        ...variantData,\n        productId: productId,\n      };\n      batch.set(newVariantRef, variantWithId);\n    });\n\n    variantIdsToDelete.forEach(variantId => {\n      const variantRef = doc(variantsCollectionRef, variantId);\n      batch.delete(variantRef);\n    });\n\n    return batch.commit();\n  }\n\n  deleteProduct(id: string): Promise<void> {\n    const docRef = doc(this.firestore, `${this.collectionPath}/${id}`);\n    return deleteDoc(docRef);\n  }\n\n  getProductsLowInStock(threshold: number = 5): Observable<Product[]> {\n    return runInInjectionContext(this.injector, () => {\n      const q = query(\n        collection(this.firestore, this.collectionPath),\n        where('totalStock', '>', 0),\n        where('totalStock', '<=', threshold),\n        orderBy('totalStock', 'asc')\n      );\n      return (collectionData(q, { idField: 'id' }) as Observable<any[]>).pipe(\n        map(items => items.map(item => convertTimestampsToDates(item) as Product))\n      );\n    });\n  }\n\n  getLatestProducts(count: number = 10): Observable<Product[]> {\n    return runInInjectionContext(this.injector, () => {\n      const q = query(\n        collection(this.firestore, this.collectionPath),\n        orderBy('createdAt', 'desc'),\n        limit(count)\n      );\n      return (collectionData(q, { idField: 'id' }) as Observable<any[]>).pipe(\n        map(items => items.map(item => convertTimestampsToDates(item) as Product))\n      );\n    });\n  }\n}"],
  "mappings": "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",
  "names": []
}
