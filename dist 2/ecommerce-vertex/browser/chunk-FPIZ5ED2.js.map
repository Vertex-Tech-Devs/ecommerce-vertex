{
  "version": 3,
  "sources": ["src/app/core/services/cart.service.ts"],
  "sourcesContent": ["import { Injectable, signal, computed, effect, inject } from '@angular/core';\nimport { Product, ProductVariant } from '@core/models/product.model';\nimport { ICart, ICartItem } from '@core/models/cart.model';\nimport { SweetAlertService } from './sweet-alert.service';\nimport { AttributeService } from './attribute.service';\nimport { take } from 'rxjs';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class CartService {\n  private sweetAlertService = inject(SweetAlertService);\n  private attributeService = inject(AttributeService);\n  private readonly CART_STORAGE_KEY = 'my_cart';\n\n  private attributeMap = new Map<string, string>();\n  cart = signal<ICart>(this.getCartFromStorage());\n\n  itemCount = computed(() => this.cart().items.reduce((acc, item) => acc + item.quantity, 0));\n\n  constructor() {\n    this.loadAttributes();\n    effect(() => {\n      this.saveCartToStorage(this.cart());\n    });\n  }\n\n  private loadAttributes(): void {\n    this.attributeService.getAttributes().pipe(take(1)).subscribe(attrs => {\n      attrs.forEach(attr => {\n        if (attr.id) {\n          this.attributeMap.set(attr.id, attr.name);\n        }\n      });\n    });\n  }\n\n  private getCartFromStorage(): ICart {\n    try {\n      const cartJson = localStorage.getItem(this.CART_STORAGE_KEY);\n      if (cartJson) {\n        const cart = JSON.parse(cartJson) as ICart;\n        if (!cart.items) {\n          return { items: [], total: 0 };\n        }\n        return cart;\n      }\n    } catch (error) {\n      console.error('Error reading cart from localStorage', error);\n      localStorage.removeItem(this.CART_STORAGE_KEY);\n    }\n    return { items: [], total: 0 };\n  }\n\n  private saveCartToStorage(cart: ICart): void {\n    try {\n      localStorage.setItem(this.CART_STORAGE_KEY, JSON.stringify(cart));\n    } catch (error) {\n      console.error('Error saving cart to localStorage', error);\n    }\n  }\n\n  private calculateTotal(items: ICartItem[]): number {\n    return items.reduce((acc, item) => acc + (item.price * item.quantity), 0);\n  }\n\n  public getVariantDescription(attributes: { [key: string]: string }): string {\n    if (this.attributeMap.size === 0) {\n      this.loadAttributes();\n    }\n    \n    return Object.entries(attributes)\n      .map(([id, value]) => {\n        const name = this.attributeMap.get(id) || id;\n        return `${name}: ${value}`;\n      })\n      .join(' / ');\n  }\n\n  addItem(product: Product, variant: ProductVariant, quantity: number): void {\n    if (quantity > variant.stock) {\n      this.sweetAlertService.error('Stock insuficiente', `No puedes añadir ${quantity}. Stock disponible: ${variant.stock}.`);\n      return;\n    }\n\n    const cartItemId = variant.id;\n    \n    this.cart.update(currentCart => {\n      const existingItem = currentCart.items.find(item => item.id === cartItemId);\n      let newItems: ICartItem[];\n\n      if (existingItem) {\n        const newQuantity = existingItem.quantity + quantity;\n        if (newQuantity > variant.stock) {\n          this.sweetAlertService.error('Stock insuficiente', `No puedes añadir más. Stock disponible: ${variant.stock}.`);\n          return currentCart;\n        }\n        newItems = currentCart.items.map(item =>\n          item.id === cartItemId ? { ...item, quantity: newQuantity } : item\n        );\n      } else {\n        const variantDescription = this.getVariantDescription(variant.attributes);\n        const newItem: ICartItem = {\n          id: cartItemId,\n          productId: product.id,\n          variantId: variant.id,\n          name: `${product.name} (${variantDescription})`,\n          price: product.price,\n          quantity: quantity,\n          image: variant.image || product.image,\n          attributes: variant.attributes,\n          stock: variant.stock\n        };\n        newItems = [...currentCart.items, newItem];\n      }\n      this.sweetAlertService.success('¡Añadido!', 'Producto añadido al carrito.');\n      return { items: newItems, total: this.calculateTotal(newItems) };\n    });\n  }\n\n  updateQuantity(itemId: string, quantity: number): void {\n    this.cart.update(currentCart => {\n      let itemToUpdate = currentCart.items.find(item => item.id === itemId);\n      let newQuantity = quantity;\n\n      if (!itemToUpdate) return currentCart;\n\n      if (newQuantity > itemToUpdate.stock) {\n        newQuantity = itemToUpdate.stock;\n        this.sweetAlertService.error('Stock insuficiente', `Solo quedan ${itemToUpdate.stock} unidades de este producto.`);\n      }\n\n      if (newQuantity < 1) {\n        newQuantity = 1;\n      }\n\n      const newItems = currentCart.items.map(item =>\n        item.id === itemId ? { ...item, quantity: newQuantity } : item\n      );\n      \n      return { items: newItems, total: this.calculateTotal(newItems) };\n    });\n  }\n\n  removeItem(itemId: string): void {\n    this.cart.update(currentCart => {\n      const newItems = currentCart.items.filter(item => item.id !== itemId);\n      this.sweetAlertService.success('Eliminado', 'El producto ha sido eliminado del carrito.');\n      return { items: newItems, total: this.calculateTotal(newItems) };\n    });\n  }\n\n  clearCart(): void {\n    this.cart.set({ items: [], total: 0 });\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
