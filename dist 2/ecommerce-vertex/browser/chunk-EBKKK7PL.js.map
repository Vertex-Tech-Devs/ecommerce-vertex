{
  "version": 3,
  "sources": ["src/app/core/services/storage.service.ts"],
  "sourcesContent": ["import { Injectable, inject } from '@angular/core';\nimport { Storage } from '@angular/fire/storage';\nimport {\n  ref,\n  uploadBytesResumable,\n  getDownloadURL,\n  deleteObject,\n  UploadTaskSnapshot,\n} from 'firebase/storage';\nimport { Observable, from, throwError } from 'rxjs';\nimport { catchError } from 'rxjs/operators';\nimport { SweetAlertService } from './sweet-alert.service';\n\nexport interface Upload {\n  progress$: Observable<number>;\n  downloadUrl$: Observable<string>;\n}\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class StorageService {\n  private readonly storage: Storage = inject(Storage);\n  private sweetAlertService = inject(SweetAlertService);\n\n  uploadFile(file: File, path: string): Upload {\n    const filePath = `${path}/${Date.now()}_${file.name}`;\n\n    const storageRef = ref(this.storage, filePath);\n    const uploadTask = uploadBytesResumable(storageRef, file);\n\n\n    const progress$ = new Observable<number>(observer => {\n      const unsubscribe = uploadTask.on('state_changed',\n        (snapshot: UploadTaskSnapshot) => {\n          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;\n          observer.next(progress);\n        },\n        (error) => observer.error(error),\n        () => observer.complete()\n      );\n      return () => unsubscribe();\n    });\n\n    const downloadUrl$ = new Observable<string>(observer => {\n      uploadTask.then(snapshot => {\n        getDownloadURL(snapshot.ref).then(url => {\n          observer.next(url);\n          observer.complete();\n        }).catch(error => observer.error(error));\n      }).catch(error => observer.error(error));\n    });\n\n    return { progress$, downloadUrl$ };\n  }\n\n  deleteFileByUrl(imageUrl: string): Observable<void> {\n    if (!imageUrl || !imageUrl.includes('firebasestorage.googleapis.com')) {\n      return from(Promise.resolve());\n    }\n\n    const imageRef = ref(this.storage, imageUrl);\n    return from(deleteObject(imageRef)).pipe(\n      catchError(error => {\n        if (error.code === 'storage/object-not-found') {\n          console.warn(\n            `El archivo en la URL ${imageUrl} no se encontrÃ³. Pudo haber sido eliminado previamente.`\n          );\n          return from(Promise.resolve());\n        }\n        console.error('Error al eliminar la imagen:', error);\n        this.sweetAlertService.error(\n          'Error de Borrado',\n          'No se pudo eliminar la imagen anterior.'\n        );\n        return throwError(() => error);\n      })\n    );\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;AAqBM,IAAO,iBAAP,MAAO,gBAAc;EACR,UAAmB,OAAO,OAAO;EAC1C,oBAAoB,OAAO,iBAAiB;EAEpD,WAAW,MAAY,MAAY;AACjC,UAAM,WAAW,GAAG,IAAI,IAAI,KAAK,IAAG,CAAE,IAAI,KAAK,IAAI;AAEnD,UAAM,aAAa,IAAI,KAAK,SAAS,QAAQ;AAC7C,UAAM,aAAa,qBAAqB,YAAY,IAAI;AAGxD,UAAM,YAAY,IAAI,WAAmB,cAAW;AAClD,YAAM,cAAc,WAAW,GAAG,iBAChC,CAAC,aAAgC;AAC/B,cAAM,WAAY,SAAS,mBAAmB,SAAS,aAAc;AACrE,iBAAS,KAAK,QAAQ;MACxB,GACA,CAAC,UAAU,SAAS,MAAM,KAAK,GAC/B,MAAM,SAAS,SAAQ,CAAE;AAE3B,aAAO,MAAM,YAAW;IAC1B,CAAC;AAED,UAAM,eAAe,IAAI,WAAmB,cAAW;AACrD,iBAAW,KAAK,cAAW;AACzB,uBAAe,SAAS,GAAG,EAAE,KAAK,SAAM;AACtC,mBAAS,KAAK,GAAG;AACjB,mBAAS,SAAQ;QACnB,CAAC,EAAE,MAAM,WAAS,SAAS,MAAM,KAAK,CAAC;MACzC,CAAC,EAAE,MAAM,WAAS,SAAS,MAAM,KAAK,CAAC;IACzC,CAAC;AAED,WAAO,EAAE,WAAW,aAAY;EAClC;EAEA,gBAAgB,UAAgB;AAC9B,QAAI,CAAC,YAAY,CAAC,SAAS,SAAS,gCAAgC,GAAG;AACrE,aAAO,KAAK,QAAQ,QAAO,CAAE;IAC/B;AAEA,UAAM,WAAW,IAAI,KAAK,SAAS,QAAQ;AAC3C,WAAO,KAAK,aAAa,QAAQ,CAAC,EAAE,KAClC,WAAW,WAAQ;AACjB,UAAI,MAAM,SAAS,4BAA4B;AAC7C,gBAAQ,KACN,wBAAwB,QAAQ,4DAAyD;AAE3F,eAAO,KAAK,QAAQ,QAAO,CAAE;MAC/B;AACA,cAAQ,MAAM,gCAAgC,KAAK;AACnD,WAAK,kBAAkB,MACrB,oBACA,yCAAyC;AAE3C,aAAO,WAAW,MAAM,KAAK;IAC/B,CAAC,CAAC;EAEN;;qCAzDW,iBAAc;EAAA;4EAAd,iBAAc,SAAd,gBAAc,WAAA,YAFb,OAAM,CAAA;;;sEAEP,gBAAc,CAAA;UAH1B;WAAW;MACV,YAAY;KACb;;;",
  "names": []
}
