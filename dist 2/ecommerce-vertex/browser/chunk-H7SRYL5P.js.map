{
  "version": 3,
  "sources": ["src/app/core/services/order.service.ts"],
  "sourcesContent": ["import { Injectable, inject, Injector, runInInjectionContext } from '@angular/core';\nimport { Observable, map } from 'rxjs';\nimport {\n  Firestore,\n  collectionData,\n} from '@angular/fire/firestore';\nimport {\n  DocumentReference,\n  WithFieldValue,\n  collection,\n  query,\n  where,\n  orderBy,\n  limit,\n} from 'firebase/firestore';\nimport { Order, OrderStatus } from '../models/order.model';\nimport { FirestoreService } from './firestore.service';\nimport { convertTimestampsToDates } from '@core/utils/date-converter';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class OrderService {\n  private firestoreService = inject(FirestoreService<Order>);\n  private firestore = inject(Firestore);\n  private injector = inject(Injector);\n  private readonly collectionPath = 'orders';\n\n  getOrders(): Observable<Order[]> {\n    return this.firestoreService.getAll(this.collectionPath);\n  }\n\n  getOrderById(id: string): Observable<Order | undefined> {\n    return this.firestoreService.get(this.collectionPath, id) as Observable<Order | undefined>;\n  }\n\n  createOrder(order: WithFieldValue<Omit<Order, 'id'>>): Promise<DocumentReference<Order>> {\n    return this.firestoreService.create(this.collectionPath, order) as Promise<DocumentReference<Order>>;\n  }\n\n  updateOrder(id: string, order: Partial<Order>): Promise<void> {\n    return this.firestoreService.update(this.collectionPath, id, order);\n  }\n\n  deleteOrder(id: string): Promise<void> {\n    return this.firestoreService.delete(this.collectionPath, id);\n  }\n\n  getGlobalSalesAndOrders(): Observable<{ totalSales: number; totalOrders: number }> {\n    return this.getOrders().pipe(\n      map(orders => {\n        const totalSales = orders\n          .filter(order => order.status === 'delivered')\n          .reduce((sum, order) => sum + order.total, 0);\n        const totalOrders = orders.length;\n        return { totalSales, totalOrders };\n      })\n    );\n  }\n\n  getMonthlySalesAndOrders(): Observable<{ monthlySales: number; monthlyOrders: number }> {\n    const CONFIRMED_SALES_STATUSES: OrderStatus[] = ['processing', 'shipped', 'delivered'];\n    \n    const now = new Date();\n    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n\n    return runInInjectionContext(this.injector, () => {\n      const collectionRef = collection(this.firestore, this.collectionPath);\n      const q = query(\n        collectionRef,\n        where('orderDate', '>=', startOfMonth)\n      );\n\n      return (collectionData(q, { idField: 'id' }) as Observable<any[]>).pipe(\n        map(items => items.map(item => convertTimestampsToDates(item) as Order)),\n        map(ordersInCurrentMonth => {\n          \n          const monthlyOrdersCount = ordersInCurrentMonth.length;\n          \n          const monthlySales = ordersInCurrentMonth\n            .filter(order => CONFIRMED_SALES_STATUSES.includes(order.status))\n            .reduce((sum, order) => sum + order.total, 0);\n\n          return { monthlySales, monthlyOrders: monthlyOrdersCount };\n        })\n      );\n    });\n  }\n\n  getPendingOrProcessingOrders(): Observable<Order[]> {\n    return runInInjectionContext(this.injector, () => {\n      const collectionRef = collection(this.firestore, this.collectionPath);\n      const q = query(\n        collectionRef,\n        where('status', 'in', ['pending', 'processing'])\n      );\n      return (collectionData(q, { idField: 'id' }) as Observable<any[]>).pipe(\n        map(items => items.map(item => convertTimestampsToDates(item) as Order)),\n        map(orders => orders.sort((a, b) => a.orderDate.getTime() - b.orderDate.getTime()))\n      );\n    });\n  }\n\n  getLatestOrders(count: number = 10): Observable<Order[]> {\n    return runInInjectionContext(this.injector, () => {\n      const collectionRef = collection(this.firestore, this.collectionPath);\n      const q = query(\n        collectionRef,\n        orderBy('orderDate', 'desc'),\n        limit(count)\n      );\n      return (collectionData(q, { idField: 'id' }) as Observable<any[]>).pipe(\n        map(items => items.map(item => convertTimestampsToDates(item) as Order))\n      );\n    });\n  }\n}"],
  "mappings": "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",
  "names": []
}
