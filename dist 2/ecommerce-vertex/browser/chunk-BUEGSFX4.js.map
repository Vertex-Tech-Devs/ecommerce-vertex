{
  "version": 3,
  "sources": ["src/app/core/services/client.service.ts"],
  "sourcesContent": ["import { Injectable, inject, Injector, runInInjectionContext } from '@angular/core';\nimport { Observable } from 'rxjs';\nimport { map } from 'rxjs/operators';\nimport { Client } from '../models/client.model';\nimport { Order } from '../models/order.model';\nimport { FirestoreService } from './firestore.service';\nimport { collection, query, where, orderBy, limit } from 'firebase/firestore';\nimport { collectionData, Firestore } from '@angular/fire/firestore';\nimport { convertTimestampsToDates } from '@core/utils/date-converter';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class ClientService {\n  private firestoreService = inject(FirestoreService<Client>);\n  private firestore: Firestore = inject(Firestore);\n  private injector = inject(Injector);\n  private readonly clientsCollectionPath = 'clients';\n  private readonly ordersCollectionPath = 'orders';\n\n  getClients(): Observable<Client[]> {\n    return this.firestoreService.getAll(this.clientsCollectionPath);\n  }\n\n  getClientByEmail(email: string): Observable<Client | undefined> {\n    return this.firestoreService.get(this.clientsCollectionPath, email);\n  }\n\n  getOrdersByClientEmail(email: string): Observable<Order[]> {\n    return runInInjectionContext(this.injector, () => {\n      const q = query(\n        collection(this.firestore, this.ordersCollectionPath),\n        where('clientEmail', '==', email)\n      );\n      return (collectionData(q, { idField: 'id' }) as Observable<any[]>).pipe(\n        map(items => items.map(item => convertTimestampsToDates(item) as Order))\n      );\n    });\n  }\n\n  getTotalClients(): Observable<number> {\n    return this.getClients().pipe(map(clients => clients.length));\n  }\n\n  getNewClientsThisMonth(): Observable<number> {\n    return runInInjectionContext(this.injector, () => {\n      const now = new Date();\n      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n\n      const q = query(\n        collection(this.firestore, this.clientsCollectionPath),\n        where('firstOrderDate', '>=', startOfMonth)\n      );\n\n      return (collectionData(q) as Observable<Client[]>).pipe(\n        map(clients => clients.length)\n      );\n    });\n  }\n\n  getLatestClients(count: number = 10): Observable<Client[]> {\n    return runInInjectionContext(this.injector, () => {\n      const collectionRef = collection(this.firestore, this.clientsCollectionPath);\n      const q = query(\n        collectionRef,\n        orderBy('lastOrderDate', 'desc'),\n        limit(count)\n      );\n      return (collectionData(q, { idField: 'id' }) as Observable<any[]>).pipe(\n        map(items => items.map(item => convertTimestampsToDates(item) as Client))\n      );\n    });\n  }\n}"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;AAaM,IAAO,gBAAP,MAAO,eAAa;EAChB,mBAAmB,OAAO,gBAAwB;EAClD,YAAuB,OAAO,SAAS;EACvC,WAAW,OAAO,QAAQ;EACjB,wBAAwB;EACxB,uBAAuB;EAExC,aAAU;AACR,WAAO,KAAK,iBAAiB,OAAO,KAAK,qBAAqB;EAChE;EAEA,iBAAiB,OAAa;AAC5B,WAAO,KAAK,iBAAiB,IAAI,KAAK,uBAAuB,KAAK;EACpE;EAEA,uBAAuB,OAAa;AAClC,WAAO,sBAAsB,KAAK,UAAU,MAAK;AAC/C,YAAM,IAAI,MACR,WAAW,KAAK,WAAW,KAAK,oBAAoB,GACpD,MAAM,eAAe,MAAM,KAAK,CAAC;AAEnC,aAAQ,eAAe,GAAG,EAAE,SAAS,KAAI,CAAE,EAAwB,KACjE,IAAI,WAAS,MAAM,IAAI,UAAQ,yBAAyB,IAAI,CAAU,CAAC,CAAC;IAE5E,CAAC;EACH;EAEA,kBAAe;AACb,WAAO,KAAK,WAAU,EAAG,KAAK,IAAI,aAAW,QAAQ,MAAM,CAAC;EAC9D;EAEA,yBAAsB;AACpB,WAAO,sBAAsB,KAAK,UAAU,MAAK;AAC/C,YAAM,MAAM,oBAAI,KAAI;AACpB,YAAM,eAAe,IAAI,KAAK,IAAI,YAAW,GAAI,IAAI,SAAQ,GAAI,CAAC;AAElE,YAAM,IAAI,MACR,WAAW,KAAK,WAAW,KAAK,qBAAqB,GACrD,MAAM,kBAAkB,MAAM,YAAY,CAAC;AAG7C,aAAQ,eAAe,CAAC,EAA2B,KACjD,IAAI,aAAW,QAAQ,MAAM,CAAC;IAElC,CAAC;EACH;EAEA,iBAAiB,QAAgB,IAAE;AACjC,WAAO,sBAAsB,KAAK,UAAU,MAAK;AAC/C,YAAM,gBAAgB,WAAW,KAAK,WAAW,KAAK,qBAAqB;AAC3E,YAAM,IAAI,MACR,eACA,QAAQ,iBAAiB,MAAM,GAC/B,MAAM,KAAK,CAAC;AAEd,aAAQ,eAAe,GAAG,EAAE,SAAS,KAAI,CAAE,EAAwB,KACjE,IAAI,WAAS,MAAM,IAAI,UAAQ,yBAAyB,IAAI,CAAW,CAAC,CAAC;IAE7E,CAAC;EACH;;qCA3DW,gBAAa;EAAA;4EAAb,gBAAa,SAAb,eAAa,WAAA,YAFZ,OAAM,CAAA;;;sEAEP,eAAa,CAAA;UAHzB;WAAW;MACV,YAAY;KACb;;;",
  "names": []
}
